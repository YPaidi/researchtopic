<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Research Topic Picker — East Asia (Malaysia)</title>
  <meta name="description" content="Pick interests, rate capabilities and constraints, and see tailored East-Asia research topics." />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; background: #0f172a; }
    .chip { @apply inline-flex items-center rounded-full border px-3 py-1 text-xs font-medium mr-2 mb-2; }
    .kpi  { @apply rounded-xl border p-3 text-slate-900 bg-white/70; }
    .card { @apply rounded-2xl border bg-white/90 shadow-sm p-5 md:p-6; }
  </style>
</head>
<body class="text-slate-900">
  <div id="root" class="min-h-full"></div>

  <!-- React 18 UMD + ReactDOM + Babel (for in-browser JSX) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // ---------- Utilities ----------
    const clamp = (v, lo=0, hi=100) => Math.max(lo, Math.min(hi, v));
    const sum = arr => arr.reduce((a,b)=>a+b,0);

    const ALL_SKILLS = [
      "literature","qualitative","quantitative","coding",
      "fieldwork","writing","language","archival","dh"
    ];

    // ---------- Suitability line (as requested) ----------
    function suitabilityLine(score) {
      const s = Math.round(score.finalScore);
      const interestPart =
        score.interestScore >= 80
          ? "matches your interests very well"
          : score.interestScore >= 50
          ? "partially matches your interests"
          : "has limited overlap with your interests";

      const skillPart =
        score.capabilityScore >= 80
          ? "your current skills are well aligned"
          : score.capabilityScore >= 50
          ? "you may need to polish some key skills"
          : "you will need significant upskilling";

      const feasibilityPart =
        score.constraintsScore >= 80
          ? "and it is feasible within your time and access"
          : score.constraintsScore >= 50
          ? "and it is likely feasible with careful planning"
          : "and it will require more time or access to be feasible";

      return `Overall fit ${s}/100 — this topic ${interestPart}; ${skillPart}, ${feasibilityPart}.`;
    }

    // ---------- Scoring ----------
    function makeProfile(selectedInterests, userSkills, userConstraints) {
      return { selectedInterests, userSkills, userConstraints };
    }

    function scoreInterests(topic, selectedInterests) {
      if (!selectedInterests.length) return 50; // neutral if user didn't choose
      const set = new Set(selectedInterests);
      const overlap = topic.tags.filter(t => set.has(t)).length;
      return clamp(Math.round((overlap / selectedInterests.length) * 100));
    }

    function scoreCapabilities(topic, userSkills) {
      // topic.skills are required levels (0–4). Score: how much of the requirement user already meets.
      const needs = ALL_SKILLS.map(k => topic.skills?.[k] ?? 0);
      const have  = ALL_SKILLS.map(k => userSkills?.[k] ?? 0);

      let parts = needs.map((need, i) => {
        if (need <= 0) return 1;                 // no requirement → perfect
        const ratio = Math.min(have[i], need) / need;
        return ratio;                            // 0..1
      });

      return clamp(Math.round((sum(parts) / parts.length) * 100));
    }

    function scoreConstraints(topic, c) {
      // c: { timeAvail(1..5), travel:boolean, ethics:boolean }
      const timeOk = Math.min(c.timeAvail, topic.timeDemand ?? 3) / (topic.timeDemand ?? 3);
      let s = 100 * timeOk;

      if (topic.needs?.travel && !c.travel) s -= 40;
      if (topic.needs?.ethics && !c.ethics) s -= 30;

      return clamp(Math.round(s));
    }

    function calcFit(topic, profile) {
      const interestScore    = scoreInterests(topic, profile.selectedInterests);
      const capabilityScore  = scoreCapabilities(topic, profile.userSkills);
      const constraintsScore = scoreConstraints(topic, profile.userConstraints);

      // weights (you can tweak)
      const WEIGHTS = { interests: 0.55, capability: 0.35, constraints: 0.10 };

      const finalScore = Math.round(
        interestScore * WEIGHTS.interests +
        capabilityScore * WEIGHTS.capability +
        constraintsScore * WEIGHTS.constraints
      );

      return { interestScore, capabilityScore, constraintsScore, finalScore };
    }

    // ---------- Small helpers ----------
    function sharesAnyTag(topic, selected) {
      const set = new Set(selected);
      return topic.tags.some(t => set.has(t));
    }

    function uniqSorted(arr) {
      return [...new Set(arr)].sort((a,b)=>a.localeCompare(b));
    }

    // ---------- Components ----------
    function App() {
      const [topics, setTopics] = useState([]);
      const [loadErr, setLoadErr] = useState(null);

      // user inputs
      const [selectedInterests, setSelectedInterests] = useState([]);
      const [userSkills, setUserSkills] = useState(() =>
        Object.fromEntries(ALL_SKILLS.map(k => [k, 2]))
      );
      const [userConstraints, setUserConstraints] = useState({
        timeAvail: 3, travel: true, ethics: true
      });

      const [onlyMatchAnyTag, setOnlyMatchAnyTag] = useState(true);

      // Load topics.json
      useEffect(() => {
        let alive = true;
        async function load() {
          try {
            const res = await fetch("topics.json", { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            if (alive) setTopics(data);
          } catch (e) {
            console.error(e);
            if (alive) setLoadErr(
              "Could not load topics.json. If you opened this file directly (file://), please host with a simple server or GitHub Pages."
            );
          }
        }
        load();
        return () => { alive = false; };
      }, []);

      const allTags = useMemo(() => {
        return uniqSorted(topics.flatMap(t => t.tags || []));
      }, [topics]);

      // Japan-focus prefilter (based on selected interests)
      const requireJapan = useMemo(
        () => selectedInterests.some(i => /japan|japanese/i.test(i)),
        [selectedInterests]
      );

      const candidateTopics = useMemo(() => {
        if (!topics.length) return [];

        const pool = requireJapan
          ? topics.filter(t => t.tags.some(tag => /japan|japanese/i.test(tag)))
          : topics;

        if (!onlyMatchAnyTag || selectedInterests.length === 0) return pool;

        const tagMatched = pool.filter(t => sharesAnyTag(t, selectedInterests));
        return tagMatched.length ? tagMatched : pool;
      }, [topics, selectedInterests, onlyMatchAnyTag, requireJapan]);

      const profile = useMemo(
        () => makeProfile(selectedInterests, userSkills, userConstraints),
        [selectedInterests, userSkills, userConstraints]
      );

      const scored = useMemo(() => {
        return candidateTopics
          .map(t => ({ topic: t, score: calcFit(t, profile) }))
          .sort((a,b) => b.score.finalScore - a.score.finalScore)
          .slice(0, 12); // top 12
      }, [candidateTopics, profile]);

      function toggleInterest(tag) {
        setSelectedInterests(prev =>
          prev.includes(tag) ? prev.filter(x => x !== tag) : [...prev, tag]
        );
      }

      return (
        <main className="max-w-6xl mx-auto p-4 md:p-8">
          <header className="mb-6">
            <h1 className="text-white text-2xl md:text-3xl font-semibold">Research Topic Picker</h1>
            <p className="text-slate-300 mt-1 text-sm md:text-base">
              Select your interests, rate your skills & practical constraints. We’ll rank topics and explain the fit clearly.
            </p>
            {loadErr && (
              <div className="mt-4 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-700">
                {loadErr}
              </div>
            )}
          </header>

          {/* Controls */}
          <section className="grid md:grid-cols-3 gap-6 mb-8">
            {/* Interests */}
            <div className="card md:col-span-3">
              <div className="flex items-start justify-between">
                <h2 className="text-lg font-semibold">Interests</h2>
                <label className="flex items-center gap-2 text-sm">
                  <input
                    type="checkbox"
                    className="h-4 w-4"
                    checked={onlyMatchAnyTag}
                    onChange={e => setOnlyMatchAnyTag(e.target.checked)}
                  />
                  <span>Prefer topics sharing my selected tags</span>
                </label>
              </div>
              <div className="mt-3 -mb-2">
                {allTags.map(tag => (
                  <button
                    key={tag}
                    onClick={() => toggleInterest(tag)}
                    className={
                      "chip " +
                      (selectedInterests.includes(tag)
                        ? "bg-indigo-600 text-white border-indigo-600"
                        : "bg-white text-slate-700 border-slate-300 hover:border-slate-400")
                    }
                    title={tag}
                  >
                    {tag}
                  </button>
                ))}
              </div>
              {selectedInterests.length === 0 && (
                <p className="mt-3 text-sm text-slate-500">Tip: pick at least 2–4 interests for better matches.</p>
              )}
            </div>

            {/* Skills */}
            <div className="card md:col-span-2">
              <h2 className="text-lg font-semibold">Capabilities (self-rating)</h2>
              <p className="text-sm text-slate-600">0 = none, 4 = strong.</p>
              <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                {ALL_SKILLS.map(k => (
                  <div key={k} className="flex items-center justify-between gap-4">
                    <label className="capitalize text-sm font-medium">{k}</label>
                    <input
                      type="range" min="0" max="4" step="1"
                      value={userSkills[k]}
                      onChange={e => setUserSkills(s => ({ ...s, [k]: Number(e.target.value) }))}
                      className="w-40"
                    />
                    <span className="text-sm w-6 text-right">{userSkills[k]}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* Constraints */}
            <div className="card">
              <h2 className="text-lg font-semibold">Constraints</h2>
              <div className="mt-4 space-y-4">
                <div className="flex items-center justify-between gap-3">
                  <label className="text-sm font-medium">Weekly time available</label>
                  <input
                    type="range" min="1" max="5" step="1"
                    value={userConstraints.timeAvail}
                    onChange={e => setUserConstraints(c => ({ ...c, timeAvail: Number(e.target.value) }))}
                    className="w-36"
                  />
                  <span className="text-sm w-6 text-right">{userConstraints.timeAvail}</span>
                </div>
                <div className="flex items-center justify-between">
                  <label className="text-sm">Can you travel locally if needed?</label>
                  <input
                    type="checkbox"
                    checked={userConstraints.travel}
                    onChange={e => setUserConstraints(c => ({ ...c, travel: e.target.checked }))}
                  />
                </div>
                <div className="flex items-center justify-between">
                  <label className="text-sm">Ethics approval possible?</label>
                  <input
                    type="checkbox"
                    checked={userConstraints.ethics}
                    onChange={e => setUserConstraints(c => ({ ...c, ethics: e.target.checked }))}
                  />
                </div>
              </div>
            </div>
          </section>

          {/* Results */}
          <section className="space-y-6">
            <div className="flex items-end justify-between">
              <h2 className="text-white text-xl font-semibold">Suggested Topics</h2>
              <p className="text-slate-300 text-sm">
                Showing {scored.length} of {candidateTopics.length} candidates
                {requireJapan ? " • Japan-focused" : ""}.
              </p>
            </div>

            {scored.map(({ topic, score }, idx) => (
              <article key={topic.id} className="card relative">
                {/* Fit score badge */}
                <div className="absolute right-4 top-4 text-center">
                  <div className="text-indigo-700 text-3xl font-semibold leading-none">{Math.round(score.finalScore)}</div>
                  <div className="text-xs text-slate-500 -mt-0.5">Fit</div>
                </div>

                <h3 className="pr-20 text-lg md:text-xl font-semibold">
                  {idx + 1}. {topic.title}
                </h3>

                {/* Approach / description (Option A) */}
                {topic.description && (
                  <p className="mt-1 text-slate-700">{topic.description}</p>
                )}

                {/* Tags */}
                <div className="mt-3 -mb-2">
                  {topic.tags.map(t => (
                    <span key={t} className="chip bg-slate-100 border-slate-200 text-slate-700">{t}</span>
                  ))}
                </div>

                {/* KPIs */}
                <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div className="kpi">
                    <div className="text-xs uppercase tracking-wide text-slate-500">Interests</div>
                    <div className="text-lg font-semibold">{score.interestScore} / 100</div>
                  </div>
                  <div className="kpi">
                    <div className="text-xs uppercase tracking-wide text-slate-500">Capabilities</div>
                    <div className="text-lg font-semibold">{score.capabilityScore} / 100</div>
                  </div>
                  <div className="kpi">
                    <div className="text-xs uppercase tracking-wide text-slate-500">Constraints</div>
                    <div className="text-lg font-semibold">{score.constraintsScore} / 100</div>
                  </div>
                </div>

                {/* Concise explanation */}
                <div className="mt-4 rounded-xl border bg-slate-50 text-slate-800 px-4 py-3">
                  {suitabilityLine(score)}
                </div>
              </article>
            ))}

            {scored.length === 0 && (
              <div className="card">
                <p>No topics match your current filters. Try selecting a few broader interests or disable “Prefer topics sharing my selected tags”.</p>
              </div>
            )}
          </section>

          <footer className="py-10 text-center text-slate-400 text-xs">
            Built for quick, student-friendly topic discovery. No “Accept Quest”, no “Quest Plan” box, and no “Review” button by design.
          </footer>
        </main>
      );
    }

    // Render safely
    const root = ReactDOM.createRoot(document.getElementById("root"));
    function safeRender() {
      try { root.render(<App/>); }
      catch (e) {
        console.error(e);
        document.getElementById("root").innerHTML =
          '<div class="max-w-3xl mx-auto p-6 mt-8 rounded-xl border bg-rose-50 text-rose-700">Runtime error. Please check the console.</div>';
      }
    }
    window.addEventListener("error", safeRender);
    window.addEventListener("unhandledrejection", safeRender);
    safeRender();
  </script>
</body>
</html>
