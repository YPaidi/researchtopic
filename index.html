<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Research Topic Game — East Asian Studies (Malaysia)</title>
  <meta name="description" content="Pick interests, rate capabilities, and get research topic suggestions with a game-like experience." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    #error-overlay {
      position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85);
      color: #fff; z-index: 9999; padding: 16px; overflow: auto; display: none;
    }
    #error-overlay pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="bg-slate-50">
  <div id="root"><div class="max-w-3xl mx-auto p-4 text-slate-700">Booting app…</div></div>
  <div id="error-overlay">
    <div class="max-w-3xl mx-auto">
      <h2 class="text-xl font-semibold mb-2">Runtime error</h2>
      <p class="mb-3">If you are on GitHub Pages, try hard refresh (Ctrl/Cmd+Shift+R). See details below:</p>
      <pre id="error-log" class="bg-slate-900/60 p-3 rounded-lg"></pre>
    </div>
  </div>

  <!-- Pin exact versions and load them BEFORE the text/babel script -->
  <script defer src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script defer src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script defer src="https://unpkg.com/@babel/standalone@7.25.7/babel.min.js"></script>

  <script>
    // Error overlay helpers
    (function () {
      const overlay = document.getElementById('error-overlay');
      const log = document.getElementById('error-log');
      function showError(e) {
        overlay.style.display = 'block';
        log.textContent = (e && e.stack) ? e.stack : String(e);
        console.error(e);
      }
      window.addEventListener('error', (ev) => showError(ev.error || ev.message));
      window.addEventListener('unhandledrejection', (ev) => showError(ev.reason || ev));
      window.__showError = showError;
    })();
  </script>

  <!-- Your app (transpiled in-browser). Make sure this tag comes AFTER the three scripts above. -->
  <script type="text/babel" data-presets="env,react">
    const { useState, useMemo, useEffect } = React;

    // Minimal inline SVG icons (no external deps)
    const Icon = ({ path, className }) => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"
           strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d={path} />
      </svg>
    );
    const Sparkles = (p) => <Icon {...p} path="M12 3l1.8 3.6L18 8.4l-3.6 1.8L12 14l-1.8-3.6L6 8.4l3.6-1.8L12 3z" />;
    const CheckCircle2 = (p) => <Icon {...p} path="M12 22a10 10 0 100-20 10 10 0 000 20zm-2-7l-2-2m2 2l6-6" />;
    const Flame = (p) => <Icon {...p} path="M12 2s4 4 4 8a4 4 0 11-8 0c0-4 4-8 4-8z" />;
    const Brain = (p) => <Icon {...p} path="M8 6a4 4 0 000 8h1v-6H8zm7 0h-1v6h1a4 4 0 000-8z" />;
    const Target = (p) => <Icon {...p} path="M12 22a10 10 0 110-20 10 10 0 010 20zm0-6a4 4 0 100-8 4 4 0 000 8z" />;
    const Timer = (p) => <Icon {...p} path="M10 2h4M12 8v4l3 3M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />;
    const Download = (p) => <Icon {...p} path="M12 3v10m0 0l-3-3m3 3l3-3M5 21h14" />;
    const MapPin = (p) => <Icon {...p} path="M12 21s7-4.35 7-10a7 7 0 10-14 0c0 5.65 7 10 7 10z" />;

    const INTERESTS = [
      "Chinese Studies (Malaysia)",
      "Japanese Studies (Malaysia)",
      "Korean Studies (Malaysia)",
      "East Asia (Comparative/Regional)",
      "China",
      "Japan",
      "South Korea",
      "North Korea",
      "Overseas Chinese/Japanese/Korean Diasporas",
      "Malaysia–East Asia Relations",
      "Society & Social Change",
      "Culture & Everyday Life",
      "Popular Culture & Media",
      "Digital Culture & Platforms",
      "Language Policy & Planning",
      "Sociolinguistics",
      "Language Education & Pedagogy",
      "Translation & Interpreting",
      "Writing Systems & Literacy",
      "History (Pre-modern)",
      "History (Modern & Contemporary)",
      "Colonialism & Postcoloniality",
      "Memory, Heritage & Museums",
      "Religion & Philosophy",
      "Gender, Sexuality & Family",
      "Youth, Education & Student Life",
      "Demography, Migration & Diaspora",
      "Urbanization, Housing & Infrastructure",
      "Rural Studies & Agriculture",
      "Economy & Development",
      "Business, Management & Work Culture",
      "Trade, FDI & Supply Chains",
      "Entrepreneurship & SMEs",
      "Corporate Governance, CSR & ESG",
      "Law, Governance & Public Policy",
      "Politics, Elections & Civil Society",
      "International Relations & Security",
      "Diplomacy, Soft Power & Cultural Exchange",
      "Media, Journalism & Public Opinion",
      "Technology, Innovation & Industry 4.0",
      "AI, Data Governance & Privacy",
      "Environment, Climate & Energy Transitions",
      "Health, Healthcare & Public Health",
      "Tourism, Heritage Routes & Creative Industries",
      "Arts, Literature & Aesthetics",
      "Foodways & Material Culture",
      "Sport & Leisure Studies",
      "Methods: Ethnography",
      "Methods: Archival & Document Analysis",
      "Methods: Survey",
      "Methods: Quantitative/Statistics",
      "Methods: Digital Humanities & GIS/Mapping",
      "Methods: Computational Social Science",
      "Comparative & Cross-Cultural Studies"
    ];

    const SKILLS = [
      { key: "literature", label: "Literature Review" },
      { key: "qualitative", label: "Qualitative Interviewing" },
      { key: "quantitative", label: "Quantitative/Stats" },
      { key: "coding", label: "Data/Code (Excel/R/Python)" },
      { key: "fieldwork", label: "Fieldwork/Observation" },
      { key: "writing", label: "Academic Writing" },
      { key: "language", label: "Language Proficiency (CN/JP/KR)" },
      { key: "archival", label: "Archival/Document Analysis" },
      { key: "dh", label: "Digital Humanities/Mapping" }
    ];

    function useTopics() {
      const [topics, setTopics] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        let cancelled = false;
        (async () => {
          try {
            const res = await fetch("topics.json", { cache: "no-store" });
            if (!res.ok) throw new Error(`Failed to load topics.json (${res.status})`);
            const data = await res.json();
            if (!Array.isArray(data)) throw new Error("topics.json must be a JSON array");
            if (!cancelled) setTopics(data);
          } catch (e) {
            if (!cancelled) setError(e.message || String(e));
          } finally {
            if (!cancelled) setLoading(false);
          }
        })();
        return () => { cancelled = true; };
      }, []);

      return { topics, loading, error };
    }

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function calcFit(topic, profile) {
      const WEIGHTS = { interests: 0.55, capability: 0.35, constraints: 0.10 };

      const overlap = (topic.tags || []).filter(t => profile.interests.includes(t)).length;
      const interestScore = (topic.tags && topic.tags.length) ? (overlap / topic.tags.length) * 100 : 0;

      const gapSum = SKILLS.map(s => s.key).reduce((sum, key) => {
        const req = (topic.skills && Number.isFinite(topic.skills[key])) ? topic.skills[key] : 0;
        const me = profile.skills[key] || 0;
        return sum + Math.max(0, req - me);
      }, 0);
      const capabilityScore = clamp(100 - gapSum * 15, 0, 100);

      let penalty = 0;
      if (topic.needs && topic.needs.travel && profile.travel < 3) penalty += 30;
      if (topic.needs && topic.needs.ethics && !profile.ethicsReady) penalty += 20;
      if (profile.timePerWeek < (Number.isFinite(topic.timeDemand) ? topic.timeDemand : 3) * 3) penalty += 20;
      const constraintsScore = clamp(100 - penalty, 0, 100);

      const finalScore = clamp(
        interestScore * WEIGHTS.interests +
        capabilityScore * WEIGHTS.capability +
        constraintsScore * WEIGHTS.constraints,
        0, 100
      );

      return { interestScore, capabilityScore, constraintsScore, finalScore };
    }

    function useBadges(progress, bestScore) {
      const badges = [];
      if (progress >= 25) badges.push({ id: "b1", name: "Curious Mind", desc: "Selected interests" });
      if (progress >= 50) badges.push({ id: "b2", name: "Self-Aware Scholar", desc: "Rated your skills" });
      if (progress >= 75) badges.push({ id: "b3", name: "Strategist", desc: "Set constraints" });
      if (bestScore >= 80) badges.push({ id: "b4", name: "Strong Fit", desc: "High-match topic" });
      return badges;
    }

    // NEW: concise one-sentence suitability line
    function suitabilityLine(score) {
      const s = Math.round(score.finalScore);
      const interestPart = score.interestScore >= 80
        ? "matches your interests very well"
        : score.interestScore >= 50
          ? "partially matches your interests"
          : "has limited overlap with your interests";

      const skillPart = score.capabilityScore >= 80
        ? "your current skills are well aligned"
        : score.capabilityScore >= 50
          ? "you may need to polish some key skills"
          : "you will need significant upskilling";

      const feasibilityPart = score.constraintsScore >= 80
        ? "and it is feasible within your time and access"
        : score.constraintsScore >= 50
          ? "and it is likely feasible with careful planning"
          : "and it will require more time or access to be feasible";

      return `Overall fit ${s}/100 — this topic ${interestPart}; ${skillPart}, ${feasibilityPart}.`;
    }

    function App() {
      const [step, setStep] = useState(1);
      const [selectedInterests, setSelectedInterests] = useState([]);
      const [skills, setSkills] = useState(Object.fromEntries(SKILLS.map(s => [s.key, 3])));
      const [timePerWeek, setTimePerWeek] = useState(6);
      const [travel, setTravel] = useState(3);
      const [ethicsReady, setEthicsReady] = useState(false);
      const [xp, setXp] = useState(0);

      const { topics, loading: loadingTopics, error: topicsError } = useTopics();

      const profile = { interests: selectedInterests, skills, timePerWeek, travel, ethicsReady };

      const progress = useMemo(() => {
        let p = 0;
        if (selectedInterests.length >= 3) p += 25;
        if (Object.keys(skills).length === SKILLS.length) p += 25;
        if (timePerWeek && travel) p += 25;
        if (step >= 4) p += 25;
        return p;
      }, [selectedInterests, skills, timePerWeek, travel, step]);

      const scored = useMemo(() => {
        return topics.map(t => ({
          topic: t,
          score: calcFit(t, profile)
        })).sort((a, b) => b.score.finalScore - a.score.finalScore);
      }, [topics, profile]);

      const bestScore = scored[0]?.score.finalScore || 0;
      const badges = useBadges(progress, bestScore);

      useEffect(() => {
        setXp(Math.min(500, Math.round(progress * 2 + bestScore)));
      }, [progress, bestScore]);

      function toggleInterest(item) {
        setSelectedInterests(prev => prev.includes(item) ? prev.filter(i => i !== item) : [...prev, item]);
      }

      return (
        <div className="min-h-screen bg-gradient-to-b from-slate-50 to-white text-slate-800">
          <header className="sticky top-0 z-10 backdrop-blur bg-white/70 border-b">
            <div className="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
              <Sparkles className="w-6 h-6 text-indigo-600" />
              <h1 className="text-xl font-semibold">Research Topic Game — East Asian Studies (MY)</h1>
              <div className="ml-auto flex items-center gap-3">
                <div className="text-sm font-medium">XP</div>
                <div className="px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 text-sm font-semibold">{xp}</div>
                <div className="hidden md:flex items-center gap-2">
                  {badges.map(b => (
                    <span key={b.id} className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs font-semibold">
                      ✓ {b.name}
                    </span>
                  ))}
                </div>
              </div>
            </div>
          </header>

          <main className="max-w-5xl mx-auto px-4 py-6">
            <div className="mb-6">
              <div className="flex justify-between text-xs text-slate-500 mb-1">
                <span>Progress</span><span>{progress}%</span>
              </div>
              <div className="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                <div className="h-full bg-indigo-600" style={{ width: progress + "%" }} />
              </div>
            </div>

            <div className="grid md:grid-cols-12 gap-6">
              <div className="md:col-span-8 space-y-6">
                {step === 1 && (
                  <section className="p-4 rounded-2xl shadow-sm border">
                    <h2 className="text-lg font-semibold mb-1">Step 1 — Choose Your Interests</h2>
                    <p className="text-sm text-slate-600 mb-3">Select at least three areas that excite you. We will prioritize topics that match these tags.</p>
                    <div className="flex flex-wrap gap-2">
                      {INTERESTS.map(item => (
                        <button
                          key={item}
                          onClick={() => toggleInterest(item)}
                          className={"px-3 py-1.5 rounded-full border text-sm transition " + (selectedInterests.includes(item) ? "bg-indigo-600 text-white border-indigo-600" : "bg-white hover:bg-slate-50")}
                        >
                          {item}
                        </button>
                      ))}
                    </div>
                  </section>
                )}

                {step === 2 && (
                  <section className="p-4 rounded-2xl shadow-sm border">
                    <h2 className="text-lg font-semibold mb-1">Step 2 — Rate Your Capabilities</h2>
                    <p className="text-sm text-slate-600 mb-3">Be honest—this helps the game suggest topics that fit you now. You can always grow.</p>
                    <div className="space-y-4">
                      {SKILLS.map(s => (
                        <div key={s.key} className="grid grid-cols-1 md:grid-cols-6 items-center gap-3">
                          <label className="md:col-span-2 text-sm font-medium">{s.label}</label>
                          <input
                            type="range"
                            min={1}
                            max={5}
                            value={skills[s.key]}
                            onChange={(e) => setSkills(prev => ({ ...prev, [s.key]: Number(e.target.value) }))}
                            className="md:col-span-3 w-full"
                          />
                          <div className="md:col-span-1 text-right text-sm font-semibold">{skills[s.key]}</div>
                        </div>
                      ))}
                    </div>
                  </section>
                )}

                {step === 3 && (
                  <section className="p-4 rounded-2xl shadow-sm border">
                    <h2 className="text-lg font-semibold mb-1">Step 3 — Set Your Constraints</h2>
                    <p className="text-sm text-slate-600 mb-3">Time, travel, and ethics readiness influence feasibility.</p>

                    <div className="space-y-4">
                      <div className="grid grid-cols-1 md:grid-cols-6 items-center gap-3">
                        <label className="md:col-span-2 text-sm font-medium flex items-center gap-2"><Timer className="w-4 h-4"/> Hours per week you can commit</label>
                        <input type="range" min={2} max={20} value={timePerWeek} onChange={(e)=> setTimePerWeek(Number(e.target.value))} className="md:col-span-3 w-full" />
                        <div className="md:col-span-1 text-right text-sm font-semibold">{timePerWeek}h</div>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-6 items-center gap-3">
                        <label className="md:col-span-2 text-sm font-medium flex items-center gap-2"><MapPin className="w-4 h-4"/> Travel/Field Access</label>
                        <input type="range" min={1} max={5} value={travel} onChange={(e)=> setTravel(Number(e.target.value))} className="md:col-span-3 w-full" />
                        <div className="md:col-span-1 text-right text-sm font-semibold">{travel}</div>
                      </div>

                      <div className="flex items-center gap-2">
                        <input id="ethics" type="checkbox" checked={ethicsReady} onChange={()=> setEthicsReady(v=>!v)} />
                        <label htmlFor="ethics" className="text-sm">I am ready to follow basic research ethics (consent, privacy, minimal risk).</label>
                      </div>
                    </div>
                  </section>
                )}

                {step >= 4 && (
                  <section className="p-4 rounded-2xl shadow-sm border">
                    <h2 className="text-lg font-semibold mb-1">Step 4 — Your Suggested Topics</h2>
                    <p className="text-sm text-slate-600 mb-4">Top matches are shown first. Each suggestion includes a one‑sentence suitability note based on your scores.</p>

                    {loadingTopics && (
                      <div className="p-4 rounded-lg bg-slate-50 border text-sm text-slate-600">Loading topics…</div>
                    )}

                    {topicsError && (
                      <div className="p-4 rounded-lg bg-rose-50 border border-rose-200 text-sm text-rose-700">
                        Failed to load topics: {topicsError}. Make sure <code>topics.json</code> is in the same folder and you are serving over HTTP(s).
                      </div>
                    )}

                    {!loadingTopics && !topicsError && (
                      <div className="space-y-4">
                        {scored.slice(0, 8).map((item, idx) => (
                          <div key={item.topic.id} className="p-4 rounded-xl border hover:shadow-sm transition bg-white">
                            <div className="flex items-start justify-between gap-3">
                              <div>
                                <h3 className="font-semibold">{idx+1}. {item.topic.title}</h3>
                                <p className="text-sm text-slate-600 mt-1">{item.topic.description}</p>
                                <div className="flex flex-wrap gap-2 mt-2">
                                  {(item.topic.tags || []).map(t => (
                                    <span key={t} className="px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 text-xs">{t}</span>
                                  ))}
                                </div>
                              </div>
                              <div className="text-right">
                                <div className="text-2xl font-bold text-indigo-700">{Math.round(item.score.finalScore)}</div>
                                <div className="text-xs text-slate-500">Fit score</div>
                              </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3 text-xs">
                              <div className="p-2 rounded-lg bg-indigo-50">
                                <div className="font-semibold">Interests</div>
                                <div>{Math.round(item.score.interestScore)} / 100</div>
                              </div>
                              <div className="p-2 rounded-lg bg-emerald-50">
